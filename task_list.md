# Qraft 6.0 开发实现规划表

> 基于 plan6.0.md 的完整开发任务分解表，确保稳步推进实施

## 任务分解与里程碑概览

### 🎯 总体目标
在不自研复杂内核/DSL的前提下，打通"数据 → 特征 → 规则策略回测 → 组合权重 → 审计入库"的单机闭环，并提供一键切换实盘的Runner。

### 📋 执行原则
- ✅ 算法优先、LLM后置增强
- ✅ 最大化引入开源、最小化自研
- ✅ 分层解耦、可复现、可回滚
- ✅ 契约测试驱动、双通道同门槛

---

## 第1阶段：基础架构与数据层（第1-2周）

### 任务1.1：项目初始化与环境搭建
**预计耗时：2-3天**
- [ ] 创建项目目录结构（mono-repo布局）
- [ ] 设置多Python版本支持（3.10/3.11）
- [ ] 建立constraints文件（stable/candidate双通道）
- [ ] 配置基础CI/CD流水线（linting + 单测）
- [ ] 创建Docker镜像构建脚本
- [ ] 建立Makefile与开发环境快速启动脚本

**交付物：**
- 项目骨架结构
- requirements-stable.txt, requirements-candidate.txt
- constraints/3.10.txt, constraints/3.11.txt
- Dockerfile与docker-compose.yml
- .github/workflows/基础CI配置

### 任务1.2：策略协议v1设计与实现
**预计耗时：3-4天**
- [ ] 定义策略协议v1的JSONSchema规范
- [ ] 实现算子注册表（operator registry）机制
- [ ] 建立算子白名单与安全约束
- [ ] 实现策略协议校验器（JSONSchema + 静态检查）
- [ ] 创建策略协议示例与测试用例
- [ ] 实现能力协商（capability negotiation）框架

**交付物：**
- qraft/schemas/strategy_v1.json
- qraft/validators/strategy_validator.py
- qraft/operators/registry.py
- 策略协议文档与示例

### 任务1.3：数据层架构与快照机制
**预计耗时：4-5天**
- [ ] 实现数据快照（snapshot）机制
- [ ] 建立snapshot_id生成规则（内容寻址）
- [ ] 实现交易日历/时区对齐工具
- [ ] 建立复权/连一数据处理流水线
- [ ] 实现CSV/Parquet数据导入器
- [ ] 创建数据版本化与谱系追踪
- [ ] 实现最小样例数据集

**交付物：**
- qraft/data/snapshot.py
- qraft/data/calendar.py
- qraft/data/importers/
- artifacts/data/sample/目录结构
- 数据快照使用文档

### 任务1.4：特征工程流水线
**预计耗时：3-4天**
- [ ] 实现基础技术指标计算（MA、EMA、RSI等）
- [ ] 建立左闭/滞后/对齐器框架
- [ ] 实现横截面排序与分组中性化
- [ ] 建立NaN传播规则与多源对齐
- [ ] 以Polars Lazy为执行引擎
- [ ] 实现去极值与标准化组件
- [ ] 创建特征流水线单元测试

**交付物：**
- qraft/features/indicators.py
- qraft/features/pipeline.py
- qraft/features/transforms.py
- 特征工程使用示例

---

## 第2阶段：回测引擎与执行层（第3-4周）

### 任务2.1：vectorbt快速回测适配
**预计耗时：3-4天**
- [ ] 实现vectorbt执行引擎适配器
- [ ] 建立策略表达式解释器（expr→信号）
- [ ] 实现参数网格搜索框架
- [ ] 建立规则模板库（MA交叉、动量、均值回复等）
- [ ] 实现批量回测与结果聚合
- [ ] 创建快速回测性能基准测试

**交付物：**
- qraft/engines/vectorbt_adapter.py
- qraft/interpreters/expression.py
- qraft/strategies/templates/
- 快速回测CLI工具

### 任务2.2：Nautilus Trader精确回测集成
**预计耗时：5-6天**
- [ ] 集成Nautilus Trader作为精确回测引擎
- [ ] 实现市场适配器（Calendar/Contract/Fees）
- [ ] 建立撮合模型与成本模型配置
- [ ] 实现订单生命周期追踪
- [ ] 建立回测/实盘同构接口
- [ ] 实现部分成交、挂撤改等微观情境

**交付物：**
- qraft/engines/nautilus_adapter.py
- qraft/adapters/market_adapters.py
- qraft/models/cost_models.py
- Nautilus配置模板

### 任务2.3：两阶段回测一致性验证
**预计耗时：2-3天**
- [ ] 实现两阶段回测对比工具
- [ ] 建立一致性验证指标（<2%差异）
- [ ] 实现冷启动复跑验证（<1%波动）
- [ ] 建立成本敏感性测试（±50%）
- [ ] 创建Top-N重叠率计算（≥70%）
- [ ] 实现自动化一致性测试流水线

**交付物：**
- qraft/validation/consistency.py
- 一致性验证报告生成器
- CI中的一致性测试

### 任务2.4：回测报表与审计包
**预计耗时：3-4天**
- [ ] 实现标准化回测报表生成
- [ ] 建立审计包（audit package）结构
- [ ] 实现Evidence Pack生成机制
- [ ] 建立内容寻址与哈希校验
- [ ] 实现MANIFEST文件生成
- [ ] 创建报表模板与可视化组件

**交付物：**
- qraft/reports/generators.py
- qraft/audit/package.py
- qraft/evidence/pack.py
- 报表模板库

---

## 第3阶段：组合优化与风险管理（第5周）

### 任务3.1：组合优化引擎集成
**预计耗时：3-4天**
- [ ] 集成PyPortfolioOpt/Riskfolio-Lib
- [ ] 实现MV、HRP、BL优化方法
- [ ] 建立复杂约束CVXPY求解器
- [ ] 实现持仓上下限、行业约束
- [ ] 建立交易成本感知优化
- [ ] 实现可行域预置与warm-start

**交付物：**
- qraft/portfolio/optimizers.py
- qraft/portfolio/constraints.py
- 组合优化配置模板

### 任务3.2：风险管理与控制
**预计耗时：3-4天**
- [ ] 实现事前风险控制（VaR/ES约束）
- [ ] 建立杠杆与仓位上限控制
- [ ] 实现波动目标与动态缩放
- [ ] 建立行业/风格中性化
- [ ] 实现单票风控与集中度限制
- [ ] 创建风险归因分析工具

**交付物：**
- qraft/risk/controls.py
- qraft/risk/attribution.py
- 风险管理配置模板

### 任务3.3：质量闸门与验收标准
**预计耗时：2-3天**
- [ ] 实现质量闸门自动化检查
- [ ] 建立双通道同门槛验证
- [ ] 实现泄漏/对齐单元测试
- [ ] 建立性能预算监控
- [ ] 实现工件复现性校验
- [ ] 创建质量报告生成器

**交付物：**
- qraft/quality/gates.py
- 质量闸门CI流水线
- 质量报告模板

---

## 第4阶段：统一Runner与CLI工具（第6周前半）

### 任务4.1：统一Runner实现
**预计耗时：3-4天**
- [ ] 实现回测/实盘统一Runner
- [ ] 建立策略协议解析与执行
- [ ] 实现参数冻结与配置锁定
- [ ] 建立灰度与回滚机制
- [ ] 实现一键切换实盘接口
- [ ] 创建Runner状态监控

**交付物：**
- qraft/runner/unified_runner.py
- qraft-cli主命令行工具
- Runner配置与使用文档

### 任务4.2：金套件（Golden Backtests）
**预计耗时：2-3天**
- [ ] 实现3-5个基准策略（MA交叉、动量、均值回复、横截面排序）
- [ ] 建立固定snapshot的金套件数据
- [ ] 实现金套件自动化验证流水线
- [ ] 建立金套件回归检测
- [ ] 创建金套件报告与对比
- [ ] 实现合同测试框架

**交付物：**
- qraft/golden/strategies.py
- artifacts/golden/数据与配置
- 金套件CI流水线

---

## 第5阶段：LLM增强层（可选，第6周后半）

### 任务5.1：LLM集成框架
**预计耗时：2-3天**
- [ ] 设计LLM增强层架构
- [ ] 实现Evidence Pack消费接口
- [ ] 建立Prompt合约与模板
- [ ] 实现LLM策略生成器
- [ ] 建立JSON Schema校验
- [ ] 实现失败回退机制

**交付物：**
- qraft/llm/enhancer.py
- qraft/llm/prompts/
- LLM增强配置模板

### 任务5.2：RD-Agent场景插件（可选）
**预计耗时：2-3天**
- [ ] 实现Qraft-Rule场景插件
- [ ] 建立RD-Agent工作空间
- [ ] 实现策略协议v1 JSON输出
- [ ] 建立成本控制与限频机制
- [ ] 实现去重缓存机制
- [ ] 创建RD-Agent集成文档

**交付物：**
- qraft/integrations/rdagent/
- RD-Agent场景配置
- 集成使用指南

---

## 第6阶段：监控与上线（第7周）

### 任务6.1：监控与告警
**预计耗时：2-3天**
- [ ] 实现Prometheus指标导出
- [ ] 建立Grafana监控面板
- [ ] 实现研究侧监控（时延、缓存率等）
- [ ] 建立执行侧监控（延迟、成交率等）
- [ ] 实现预警阈值与告警规则
- [ ] 创建监控运维文档

**交付物：**
- qraft/monitoring/exporters.py
- grafana/dashboards/
- 监控配置模板

### 任务6.2：灰度与上线流程
**预计耗时：2-3天**
- [ ] 实现纸上交易模式
- [ ] 建立小资金灰度流程
- [ ] 实现一键回滚机制
- [ ] 建立审批流与发布流程
- [ ] 实现上线前检查清单
- [ ] 创建上线运维手册

**交付物：**
- qraft/deployment/grayscale.py
- 上线检查清单
- 运维手册

---

## 第7阶段：稳定性与增强（第8周及后续）

### 任务7.1：开源依赖升级SOP
**预计耗时：持续改进**
- [ ] 实现Dependabot/Renovate集成
- [ ] 建立分层验证清单
- [ ] 实现升级验证流水线
- [ ] 建立回滚与监控机制
- [ ] 创建UPGRADELOG生成器
- [ ] 完善升级SOP文档

### 任务7.2：性能优化与稳定性
**预计耗时：持续改进**
- [ ] 实现数值稳定性保障
- [ ] 建立跨平台一致性测试
- [ ] 实现性能基准测试
- [ ] 优化热点计算路径
- [ ] 建立压力测试框架
- [ ] 实现自动化回归检测

### 任务7.3：文档与培训
**预计耗时：1-2周**
- [ ] 完善API文档与示例
- [ ] 创建用户使用指南
- [ ] 建立最佳实践文档
- [ ] 实现交互式教程
- [ ] 创建故障排查手册
- [ ] 建立社区贡献指南

---

## 验收标准与门槛

### 🎯 硬门槛（必须通过）
- ✅ 冷启动复跑核心指标波动 < 1%
- ✅ 两阶段一致性关键指标差 < 2%
- ✅ 成本敏感性Top-N重叠率 ≥ 70%
- ✅ 泄漏与对齐器单测全通过
- ✅ 双通道同门槛验证通过
- ✅ 金套件回归检测通过

### 📊 软指标（持续改进）
- 📈 策略池质量与多样性
- 📈 回测执行性能
- 📈 LLM增强效果（可选）
- 📈 监控覆盖度
- 📈 文档完备性

---

## 风险控制与应急预案

### ⚠️ 主要风险点
1. **开源依赖兼容性**：版本锁定 + 适配层 + 回退机制
2. **数值稳定性**：统一环境 + 确定性配置 + 跨平台测试
3. **LLM集成复杂度**：可选架构 + 失败回退 + 独立验证
4. **性能瓶颈**：基准测试 + 热点监控 + 渐进优化

### 🚨 应急预案
- **开发延期**：优先MVP功能，延后可选增强
- **集成问题**：回退上个稳定版本，修复后重新集成
- **性能问题**：启用缓存，优化热点，必要时降级精度
- **质量门槛**：调整阈值，增加测试覆盖，强化验证

---

## 总结

这个开发规划表将Qraft 6.0的实现分解为7个阶段，共计约8周的开发周期。每个任务都有明确的交付物和验收标准，确保能够稳步推进项目落地。

关键成功因素：
1. **严格遵循算法优先、LLM后置的架构原则**
2. **基于成熟开源组件，最小化自研风险**
3. **契约测试驱动，确保质量门槛**
4. **分层解耦，支持渐进式演进**
5. **全链路可复现，支持灰度与回滚**

建议按照此规划表逐步执行，每完成一个里程碑进行验收评估，确保项目按期高质量交付。