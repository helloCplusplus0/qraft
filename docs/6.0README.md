# Qraft 6.0

Qraft 是一个研究到执行的一体化量化平台，采用分层解耦的单仓（mono-repo）结构。

## 快速开始

1) 准备环境

- Python 3.10 或 3.11
- 可选：Docker / Docker Compose

2) 安装依赖（本地）

```
make setup
```

3) 代码质量与测试

```
make lint
make mypy
make test
```

4) 使用 Docker 开发环境

```
./scripts/dev-env.sh
```

5) CLI 用法

安装包（可编辑模式）以启用 `qraft` 命令：

```
make install
```

校验策略 JSON：

```
qraft validate path/to/strategy.json
```

- 返回码：通过为 0，失败为非 0；失败时打印错误详情到 stderr。

列出支持的算子（能力协商，简洁命令）：

```
qraft ops
```

## 特征流水线使用示例

Qraft 的特征工程模块提供技术指标、横截面变换和多数据源对齐功能，避免前瞻偏误。

### 基础用法

```python
import polars as pl
from qraft.features import ma, ema, rsi, cs_rank, cs_zscore, align_on_ts, lag

# 创建示例价格数据（包含 ts, symbol, close 列）
df = pl.DataFrame({
    "ts": ["2024-01-01", "2024-01-02", "2024-01-03"] * 2,
    "symbol": ["AAPL"] * 3 + ["MSFT"] * 3,
    "close": [150.0, 152.0, 148.0, 300.0, 305.0, 298.0]
}).with_columns(pl.col("ts").str.to_date())

# 转为 LazyFrame（推荐用法）
lf = df.lazy()

# 计算技术指标（左闭窗口，默认滞后1期避免前瞻）
lf = ma(lf, "close", window=3)  # 3期移动平均
lf = ema(lf, "close", span=5)   # 5期指数移动平均
lf = rsi(lf, "close", window=3) # 3期相对强弱指数

# 横截面标准化（每个时点跨股票）
lf = cs_zscore(lf, "close")     # Z-score标准化
lf = cs_rank(lf, "close", method="dense")  # 排序转换

# 手动滞后（额外滞后2期）
lf = lag(lf, "close", periods=2, out="close_lag2")

result = lf.collect()
print(result)
```

### 多数据源对齐

```python
# 准备不同频率/来源的数据
price_lf = pl.DataFrame({
    "ts": ["2024-01-01", "2024-01-02", "2024-01-03"],
    "symbol": ["AAPL", "AAPL", "AAPL"],
    "close": [150.0, 152.0, 148.0]
}).lazy()

volume_lf = pl.DataFrame({
    "ts": ["2024-01-01", "2024-01-02"],
    "symbol": ["AAPL", "AAPL"],
    "volume": [1000000, 1200000]
}).lazy()

# 对齐多个数据源（内连接，确保无缺失）
aligned = align_on_ts({
    "price": price_lf,
    "vol": volume_lf
}, how="inner")

print(aligned.collect())
# 输出列：ts, symbol, price__close, vol__volume
```

### 策略因子流水线示例

```python
def create_momentum_factor(price_lf: pl.LazyFrame) -> pl.LazyFrame:
    """创建动量因子：价格动能 + 技术指标组合"""
    
    # 1. 计算技术指标
    lf = ma(price_lf, "close", window=20)  # 20日均线
    lf = rsi(lf, "close", window=14)       # 14日RSI
    
    # 2. 计算价格动能（滞后避免前瞻）
    lf = lag(lf, "close", periods=1, out="close_lag1")
    lf = lag(lf, "close", periods=5, out="close_lag5")
    
    # 价格5日动能
    lf = lf.with_columns(
        ((pl.col("close_lag1") - pl.col("close_lag5")) / pl.col("close_lag5")).alias("ret_5d")
    )
    
    # 3. 横截面标准化（每日跨股票）
    lf = cs_zscore(lf, "ret_5d")
    lf = cs_zscore(lf, "close_rsi14")
    
    # 4. 组合因子（简单等权）
    lf = lf.with_columns(
        (0.5 * pl.col("ret_5d_z") + 0.5 * pl.col("close_rsi14_z")).alias("momentum_factor")
    )
    
    return lf.select(["ts", "symbol", "momentum_factor"])

# 使用示例
factor_lf = create_momentum_factor(price_lf)
print(factor_lf.collect())
```

关键特性：
- **左闭窗口**：所有指标默认滞后1期，避免使用当期数据
- **分组计算**：自动检测symbol列，按股票分组计算
- **类型安全**：基于Polars的强类型LazyFrame操作
- **性能优化**：延迟计算，支持大规模数据处理

更多API详见 `qraft.features` 模块文档。

## 目录结构

- qraft/ 核心代码（数据/特征/策略/引擎/工具等）
- requirements/ 依赖与多 Python 版本约束
- docker/ Dockerfile.dev 与 Dockerfile.prod
- .github/workflows/ GitHub Actions CI
- scripts/ 常用脚本（setup/dev/test）

## 测试覆盖与质量闸门（更新）

- 质量门：make test 强制覆盖率 ≥ 80%，否则 CI 失败。
- 当前状态：单测 49 通过，总覆盖率约 93%，关键模块覆盖：
  - qraft/engines/vectorbt_adapter.py：100%
  - qraft/features/transforms.py：92%
  - qraft/interpreters/expression.py：97%
- 新增边界用例：
  - 适配器：start/end 切片、单列自动对齐、无重叠列报错、单列 equity 为 Series 分支。
  - 特征：cs_rank(minmax)、winsorize(0/1)、单 symbol zscore（std=NaN）。
  - CLI：quickbacktest 启动时的 start/end 边界过滤与对齐验证。

## 许可证

TBD